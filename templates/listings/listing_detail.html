{% extends "base.html" %}
{% block content %}
<!-- Listing detail: modern, animated, full-featured -->
<div class="bg-gray-50 min-h-screen">
  <!-- Top notch hero -->
  <div class="relative overflow-hidden">
    <!-- Decorative notch / clip -->
    <div class="absolute inset-x-0 -top-8 pointer-events-none">
      <svg viewBox="0 0 1440 120" class="w-full h-20" preserveAspectRatio="none">
        <path d="M0,32L80,53.3C160,75,320,117,480,122.7C640,128,800,96,960,90.7C1120,85,1280,107,1360,117.3L1440,128L1440,0L1360,0C1280,0,1120,0,960,0C800,0,640,0,480,0C320,0,160,0,80,0L0,0Z"
          class="fill-white"></path>
      </svg>
    </div>

    <div class="max-w-6xl mx-auto px-4 lg:px-8 pt-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
        <!-- Left: Gallery -->
        <div class="lg:col-span-2">
          <div class="relative bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Main slider -->
            <div id="gallery" class="relative aspect-[16/9] bg-gray-100">
              {% comment %} Main image area: will be populated by JS slider switching {% endcomment %}
              {% if listing.images.all %}
                {% for img in listing.images.all %}
                  <img data-index="{{ forloop.counter0 }}" 
                       src="{{ img.image.url }}" 
                       alt="Image {{ forloop.counter }}" 
                       class="gallery-slide absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500 ease-out">
                {% endfor %}
              {% else %}
                <div class="h-96 flex items-center justify-center text-gray-500">
                  No Images Available
                </div>
              {% endif %}
              <!-- left/right arrows -->
              <button id="prevBtn" class="hidden lg:flex absolute left-4 top-1/2 -translate-y-1/2 bg-black/40 text-white rounded-full p-2 hover:bg-black/60 z-20">
                ‹
              </button>
              <button id="nextBtn" class="hidden lg:flex absolute right-4 top-1/2 -translate-y-1/2 bg-black/40 text-white rounded-full p-2 hover:bg-black/60 z-20">
                ›
              </button>

              <!-- dark gradient bottom for thumbnails -->
              <div class="absolute bottom-0 left-0 right-0 pointer-events-none" aria-hidden>
                <div class="h-20 bg-gradient-to-t from-black/30 to-transparent"></div>
              </div>
            </div>

            <!-- Thumbnail strip -->
            <div class="bg-white px-4 py-3 border-t hidden lg:block">
              <div id="thumbStrip" class="flex gap-3 overflow-x-auto py-1">
                {% for img in listing.images.all %}
                  <button data-index="{{ forloop.counter0 }}" class="thumb-btn rounded-lg flex-none border-2 border-transparent focus:outline-none focus:border-teal-500 transition">
                    <img src="{{ img.image.url }}" class="w-28 h-16 object-cover rounded" loading="lazy" alt="thumb {{ forloop.counter }}">
                  </button>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Mobile small thumbnail row -->
          <div class="mt-3 flex gap-2 lg:hidden overflow-x-auto px-1">
            {% for img in listing.images.all %}
              <button data-index="{{ forloop.counter0 }}" class="thumb-btn rounded-lg flex-none border-2 border-transparent focus:outline-none focus:border-teal-500 transition">
                <img src="{{ img.image.url }}" class="w-24 h-14 object-cover rounded" loading="lazy" alt="thumb mobile {{ forloop.counter }}">
              </button>
            {% endfor %}
          </div>

          <!-- Title & meta -->
          <div class="mt-6 px-1 lg:px-0">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h1 class="text-2xl lg:text-3xl font-extrabold tracking-tight">{{ listing.title }}</h1>
                <p class="mt-1 text-sm text-gray-500">{{ listing.address|default:"Location not specified" }}</p>
              </div>
              <div class="hidden lg:flex items-center gap-3">
                <button id="shareBtn" class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-gray-200 hover:shadow">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 8a3 3 0 10-2.83-2H9" />
                  </svg>
                  Share
                </button>
              </div>
            </div>

            <div class="mt-4 flex gap-3 items-center">
              <span class="inline-flex items-center gap-2 px-3 py-1 bg-amber-200 rounded text-sm font-medium">
                {{ listing.status|title }}
              </span>
              <span class="text-sm text-gray-600">Available from: <strong>{{ listing.available_from|date:"M d, Y" }}</strong></span>
            </div>

            <div class="mt-4 prose max-w-none">
              <h3 class="text-lg font-semibold">About this room</h3>
              <p class="text-gray-700">{{ listing.description|linebreaksbr }}</p>
            </div>
          </div>

          <!-- Amenities -->
          <div class="mt-6">
            <h3 class="text-lg font-semibold mb-3">Amenities</h3>
            <div class="flex flex-wrap gap-2">
              {% for item in listing.amenities %}
                <span class="px-3 py-1 rounded-full bg-gradient-to-tr from-gray-100 to-white text-sm shadow-sm">{{ item|title }}</span>
              {% empty %}
                <span class="text-gray-500">No amenities added.</span>
              {% endfor %}
            </div>
          </div>

        </div>

        <!-- Right: Sticky action & owner card -->
        <aside class="relative">
          <div id="actionPanel" class="sticky top-20 bg-white rounded-xl p-5 shadow-lg border border-gray-100 w-full">
            <div class="flex items-baseline justify-between gap-4">
              <div>
                <p class="text-sm text-gray-500">Rent</p>
                <div class="text-2xl font-bold text-emerald-600">₹{{ listing.rent }}</div>
                <div class="text-sm text-gray-500">Deposit ₹{{ listing.deposit }}</div>
              </div>
              <div class="text-right">
                <span class="inline-block text-xs px-2 py-1 rounded bg-yellow-300 text-black">{{ listing.status|title }}</span>
              </div>
            </div>

            <div class="mt-4 flex flex-col gap-3">
              <button id="interestedBtn" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold shadow hover:bg-emerald-700 transform hover:-translate-y-0.5 transition">
                I'm Interested
              </button>

              <a href="javascript:history.back()" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200">
                Go Back
              </a>
            </div>

            <div class="mt-4 border-t pt-4 text-sm text-gray-600">
              <div>Available: <strong>{{ listing.available_from|date:"d M, Y" }}</strong></div>
              <div class="mt-2">Preferred: <strong>{{ listing.preferred_gender|title }}</strong></div>
            </div>
          </div>

          <!-- Owner / contact card -->
          <div class="mt-6">
            <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
              <div class="flex items-center gap-3">
                <div class="w-14 h-14 rounded-full bg-gray-200 flex items-center justify-center text-xl font-semibold text-white">
                  {{ listing.owner.full_name|slice:":1"|upper }}
                </div>
                <div>
                  <div class="font-semibold">{{ listing.owner.full_name }}</div>
                  <div class="text-sm text-gray-500">{{ listing.owner.email }}</div>
                </div>
              </div>

              <div class="mt-3 grid grid-cols-1 gap-2 text-sm">
                <div>Phone: <strong>{{ listing.owner.phone }}</strong></div>
                <div class="text-gray-500">Member since: <strong>{{ listing.owner.date_joined|date:"M Y" }}</strong></div>
              </div>

              <div class="mt-3 flex gap-2">
                <a href="mailto:{{ listing.owner.email }}" class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Email Owner</a>
                <button id="openContactModal" class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 rounded border border-gray-200">Message</button>
              </div>
            </div>
          </div>

        </aside>
      </div>

      <!-- Map & extras -->
      <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-xl p-4 border">
          <h4 class="font-semibold mb-2">Location</h4>
          <div class="w-full h-64 rounded overflow-hidden bg-gray-100">
            <!-- placeholder map: replace with real embed / leaflet map -->
            {% if listing.latitude and listing.longitude %}
              <iframe class="w-full h-full border-0" loading="lazy"
                src="https://www.google.com/maps?q={{ listing.latitude }},{{ listing.longitude }}&hl=es;z=14&output=embed"></iframe>
            {% else %}
              <div class="w-full h-full flex items-center justify-center text-gray-400">Location not provided</div>
            {% endif %}
          </div>
        </div>

        <div class="bg-white rounded-xl p-4 border">
          <h4 class="font-semibold mb-2">House Rules</h4>
          <p class="text-gray-600 text-sm">
            <!-- placeholder: include real rules field if you have one -->
            Be respectful. No smoking inside. Keep common areas tidy.
          </p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Contact modal (hidden) -->
<div id="contactModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
  <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-xl">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">Message Owner</h3>
      <button id="closeModal" class="text-gray-500">✕</button>
    </div>

    <form method="post" action="/chat/create/{{ listing.id }}/" class="mt-4">
      {% csrf_token %}
      <label class="block text-sm text-gray-700">Your message</label>
      <textarea name="message" rows="5" required class="mt-2 w-full rounded border p-2"></textarea>

      <div class="mt-4 flex gap-2 justify-end">
        <button type="button" id="modalCancel" class="px-4 py-2 rounded bg-gray-100">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white">Send</button>
      </div>
    </form>
  </div>
</div>

<!-- Lightbox for large image view -->
<div id="lightbox" class="fixed inset-0 hidden z-60 items-center justify-center bg-black/80">
  <button id="lightboxClose" class="absolute right-6 top-6 text-white z-50 text-3xl">×</button>
  <img id="lightboxImg" src="" class="max-w-[90%] max-h-[90%] rounded shadow-lg" alt="Large view">
</div>

<!-- JS: gallery slider, thumbnails, modal, animations -->
<script>
  (function () {
    // get slides
    const slides = Array.from(document.querySelectorAll('.gallery-slide'));
    let current = 0;
    const prev = document.getElementById('prevBtn');
    const next = document.getElementById('nextBtn');
    const thumbs = Array.from(document.querySelectorAll('.thumb-btn'));
    const interestedBtn = document.getElementById('interestedBtn');
    const contactModal = document.getElementById('contactModal');
    const openContact = document.getElementById('openContactModal');
    const closeModal = document.getElementById('closeModal');
    const modalCancel = document.getElementById('modalCancel');
    const shareBtn = document.getElementById('shareBtn');

    // show current index
    function showIndex(i, fade = true) {
      if (!slides.length) return;
      current = (i + slides.length) % slides.length;
      slides.forEach((s, idx) => {
        if (idx === current) {
          s.classList.remove('opacity-0'); s.classList.add('opacity-100');
        } else {
          s.classList.remove('opacity-100'); s.classList.add('opacity-0');
        }
      });
      // highlight thumb
      thumbs.forEach((t, idx) => {
        t.classList.toggle('ring-2 ring-teal-500', idx === current);
      });
    }

    // init
    showIndex(0);

    // prev / next handlers
    prev?.addEventListener('click', () => showIndex(current - 1));
    next?.addEventListener('click', () => showIndex(current + 1));

    // autoplay small subtle
    let autoplay = setInterval(() => showIndex(current + 1), 6000);
    // pause on hover
    const galleryEl = document.getElementById('gallery');
    galleryEl?.addEventListener('mouseenter', () => clearInterval(autoplay));
    galleryEl?.addEventListener('mouseleave', () => { autoplay = setInterval(() => showIndex(current + 1), 6000); });

    // thumbnails
    thumbs.forEach(t => {
      t.addEventListener('click', () => {
        const idx = Number(t.dataset.index);
        showIndex(idx);
      });
    });

    // thumbnail & main click => lightbox
    slides.forEach(s => s.addEventListener('click', () => {
      const src = s.getAttribute('src') || s.currentSrc;
      openLightbox(src);
    }));
    thumbs.forEach(t => t.addEventListener('dblclick', () => {
      const img = t.querySelector('img');
      openLightbox(img?.src);
    }));

    // lightbox functions
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const lightboxClose = document.getElementById('lightboxClose');
    function openLightbox(src) {
      if (!src) return;
      lightboxImg.src = src;
      lightbox.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    function closeLightbox() {
      lightbox.classList.add('hidden');
      document.body.style.overflow = '';
      lightboxImg.src = '';
    }
    lightboxClose?.addEventListener('click', closeLightbox);
    lightbox?.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });

    // Contact modal handlers
    interestedBtn?.addEventListener('click', () => contactModal.classList.remove('hidden') || contactModal.classList.add('flex'));
    openContact?.addEventListener('click', () => contactModal.classList.remove('hidden') || contactModal.classList.add('flex'));
    closeModal?.addEventListener('click', () => contactModal.classList.add('hidden'));
    modalCancel?.addEventListener('click', () => contactModal.classList.add('hidden'));
    contactModal?.addEventListener('click', (e) => { if (e.target === contactModal) contactModal.classList.add('hidden'); });

    // Share button: copy link
    shareBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(window.location.href);
        shareBtn.textContent = 'Link Copied';
        setTimeout(() => shareBtn.innerHTML = 'Share', 2000);
      } catch (err) {
        alert('Could not copy link. Please copy manually.');
      }
    });

    // subtle reveal on scroll
    const revealEls = document.querySelectorAll('.prose, .bg-white');
    const obs = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          e.target.classList.add('animate-fadeInUp');
          obs.unobserve(e.target);
        }
      });
    }, { threshold: 0.12 });
    revealEls.forEach(el => obs.observe(el));
  })();
</script>

<!-- small custom animations -->
<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeInUp { animation: fadeInUp 500ms ease-out both; }
  /* slideshow opacity helper */
  .gallery-slide { opacity: 0; }
  .gallery-slide.opacity-100 { opacity: 1; }
  .gallery-slide.opacity-0 { opacity: 0; }
</style>

{% endblock %}
